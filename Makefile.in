# makefile for magicfilter-2

OBJS=getline.o xyzzy.o actions.o magic.o trace.o reject.o args.o getaline.o
LIB     = libmf.a
CC      = @CC@
LDFLAGS = -Lfile -L. @LDFLAGS@
CFLAGS  = -I@srcdir@ -I@srcdir@/file @CFLAGS@
LIBES   = -lmf -lfile @LIBS@
RANLIB  = @RANLIB@
PROGS=traditional magicfilter mpp textonly
FILE	= file/libfile.a
VPATH   = @srcdir@

all: $(PROGS)

$(FILE):
	cd file && $(MAKE) all

textonly: contrib/textonly.c
	$(CC) $(CFLAGS) -o textonly $<

mpp: magic.m4 mkmpp
	@srcdir@/mkmpp magic.m4

traditional: $(LIB) fe.c $(FILE)
	$(CC) $(LDFLAGS) -DNOFE -o traditional @srcdir@/fe.c $(LIBES)

magicfilter: $(LIB) fe.c $(FILE)
	$(CC) $(LDFLAGS) -o magicfilter @srcdir@/fe.c $(LIBES)

$(OBJS): rule.h magicfilter.h

$(LIB): $(OBJS) @XGETOPT@
	$(AR) cr $(LIB) $(OBJS) @XGETOPT@
	$(RANLIB) $(LIB)

ignore @XGETOPT@: basis/options.h basis/options.c
	$(CC) $(CFLAGS) -c -o @XGETOPT@ @srcdir@/basis/options.c

magic.c: magic.m4 mkmagic config.h
	@srcdir@/mkmagic magic.m4

magicfile: file/magic
	cd file && make magic

commoninstall: textonly magicfile
	@INSTALL@ -d $(prefix)/@exedir@
	@INSTALL@ -d $(prefix)/@mandir@/man8
	@INSTALL@ -d $(prefix)/@mandir@/man5
	@INSTALL@ -d $(prefix)/@filterdir@
	@INSTALL_MAGIC@ -m 444 file/magic $(prefix)/@MAGIC@
	@INSTALL_PROGRAM@ -m 511 textonly $(prefix)/@filterdir@

install:  @DO_WHAT@

install-traditional: traditional commoninstall install-manpages-t
	@INSTALL_PROGRAM@ -m 511 traditional $(prefix)/@exedir@/magicfilter-t
	./mkmpp
	for x in filters/*.def;do \
	    ./mpp @exedir@/magicfilter-t $$x > $(prefix)/@filterdir@/`basename $$x .def`-filter; \
	    chmod +x $(prefix)/@filterdir@/`basename $$x .def`-filter; \
	done
	@rm -f mpp

install-manpages: VERSION
	@SED@ -n -e 's/&PROGRAM&/magicfilter/g' -e 's/^MAN //p' -e @LPD_OPTS@ < magicfilter.8templ > $$$$; \
	@INSTALL_DATA@ -m 444 $$$$ $(prefix)/@mandir@/man8/magicfilter.8; \
	rm -f $$$$
	@INSTALL_DATA@ -m 444 magicfilter.5 $(prefix)/@mandir@/man5

install-manpages-t: VERSION
	@SED@ -n -e 's/&PROGRAM&/magicfilter-t/g' -e 's/^MAN //p' -e 's/^TRAD//p' -e @LPD_OPTS@ < magicfilter.8templ > $$$$; \
	@INSTALL_DATA@ -m 444 $$$$ $(prefix)/@mandir@/man8/magicfilter-t.8; \
	rm -f $$$$
	@INSTALL_DATA@ -m 444 magicfilter-t.5 $(prefix)/@mandir@/man5

install-magicfilter: magicfilter commoninstall install-manpages
	@INSTALL_PROGRAM@ -m 511 magicfilter $(prefix)/@exedir@
	for x in filters/*.def;do \
	    sed -e 's,@MAGIC''FILTER@,@exedir@/magicfilter,' < $$x > $(prefix)/@filterdir@/`basename $$x .def`; \
	    chmod +x $(prefix)/@filterdir@/`basename $$x .def`; \
	done

export: VERSION
	V=`cat VERSION`; \
	if bk export -tplain -r+ /tmp/magicfilter-$$V; then \
	    cd /tmp; \
	    tar czf magicfilter-$$V.tar.gz magicfilter-$$V; \
	    rm -rf magicfilter-$$V; \
	fi

spotless distclean: clean
	rm -f @GENERATED_FILES@ @CONFIGURE_FILES@

clean:
	rm -f $(OBJS) magic.c $(PROGS) $(LIB) @XGETOPT@
	cd file && $(MAKE) clean

# redefine .c.o to get around gmake
.c.o:
	$(CC) $(CFLAGS) -c -o $*.o $<
